---
title: "Drinks and spice tolerance"
author: "Hadees"
date: "3/22/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, message = FALSE, echo=FALSE}
# Students: You probably shouldn't change any of the code in this chunk.

# These are the packages you will need for this activity
packages_needed <- c("tidyverse", "readxl", "janitor", "lme4", "lmerTest", "pwr", "lsmeans")

package.check <- lapply(
  packages_needed,
  FUN = function(x) {
    if (!require(x, character.only = TRUE)) {
      install.packages(x, dependencies = TRUE)
    }
  }
)

# Credit: package.check based on a helpful post from Vikram Baliga https://vbaliga.github.io/verify-that-r-packages-are-installed-and-loaded/

# Load tidyverse
library(tidyverse)
library(readxl)
library(janitor)
library(lme4)
library(lmerTest)
library(pwr)
library(lsmeans)
# Set so that long lines in R will be wrapped:
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80))
```


```{r}
dat <- read.csv("~/Spicy_Data.csv")
attach(dat)
```


## Introduction
I love hot sauce and I think it's to an extent of masochism. I end up taking the hottest sauce and too much of it. I end up regretting it once I've endured the pain for more than 10 minutes or I'm on the toilet. I've created an experiment to determine which drink would be best to relieve the pain as quick as possible.

The experiment analyzes how various drinks, and temperatures can affect the time taken to relieve the sensation of spice. Since many say that milk is the best way to combat spicy foods we wanted to test this out. Thus, I used four drinks; milk, water, Coke, and apple juice. At two different temperatures; one which is room temperature (warm, around 20 degrees celsius), and the other refrigerated (cold, 4 degrees celsius). I've also gathered 5 brave volunteers to help me with this experiment including 2 brothers and 3 friends.

To begin, I will define a few aspects of the experiment.  

**Experimental Unit:** A family member or friend participating in the consumption of hot sauce. (6 total experimental units in this study including me).  
**Population:** Set of all members consuming hot sauce  
**Factors:** Drinks, with four levels (water, milk, Coke, apple juice), and Temperature with two levels (20 degrees celsius, and 4 degrees celsius).   
**Response:** The amount of time taken in seconds for the sensation of spice to be eradicated.  
  
Before beginning the experiment, there were a few considerations to make. Each individual participant may have their own spice tolerance influenced by various things out of our control such as cultural foods, I  will mention how I countered this problem later in the report, but for now the model that was used in a way allows there to be **blocking** in the experiment, as this nuisance variable cannot be controlled for. Another thing that was considered was the amount of fluid the participant should consume for each treatment, and the amount of spice the participant should intake. Thus, I decided to incorporate **control** in the experiment, every participant will intake 1 teaspoon of the Scorpion Pepper Hot Sauce, with 250mL (1 cup) of the treatment. Since I needed these results to be generalized I introduced **replication** into the study by having more than one experimental unit in the study. Another consideration I had to make while designing the study is the potential of becoming accustomed to the spice. So for an example, if a participant were to intake the hot sauce every three hours there is a potential for the spice to have less of an effect on the participant in the later trials which would have an influence on the study as a whole. Thus I decided to **randomize** the amount of time in between trials, from anywhere between an hour to eight hours to make sure the participants don't get into a routine of taking the spice, and have ample time to recover from the previous trial.
  
The null hypotheses of this experiment are:  
$H_{0}$: $\mu_{\textrm{refrigerated}}$ = $\mu_{\textrm{room temperature}}$  
$H_{0}$: $\mu_{\textrm{soda}}$ = $\mu_{\textrm{milk}}$ = $\mu_{\textrm{juice}}$= $\mu_{\textrm{water}}$

And the corresponding alternate hyphetheses are:  
$H_{A}$: $\mu_{\textrm{refrigerated}} \neq \mu_{\textrm{room temperature}}$  
$H_{A}$: At least one of $\mu_{\textrm{soda}}$,$\mu_{\textrm{milk}}$, $\mu_{\textrm{juice}}$, $\mu_{\textrm{water}}$ is different


## Interaction Model
Once the data has been collected, I want to see whether there are any interactions between the factors. 

```{r}
with(dat, interaction.plot(Drink, Temperature, dat$Time, 
                           col = c("brown", "pink"), main="Interaction Between Temperature and Drink"))
```

However, something quite interesting was seen in the interaction plots. Even though participants were not a factor in the planning of the study, from the plots we see an interaction between participants, and drink.
```{r}
with(dat, interaction.plot(Participants, Drink, dat$Time, 
                           col = c("red", "blue"), main="Interaction Between Participant and Drink"))
```

But we don't see an interaction between participants, and temperature.
```{r}
with(dat, interaction.plot(Participants, Temperature, dat$Time, 
                           col = c("purple", "green"), main="Interaction Between Participant and Temperature"))
```

This seems worrying, as participants shouldn’t be a factor in this study, however after plotting the model of interactions with participants, and obtaining an anova table:

```{r}
model_int <- lm(dat$Time ~ Participants*Drink + Temperature, data = dat)
anova(model_int)
```

We see a p-value of 0.1058, which compared to the 0.05 significance level can conclude the interaction between participants, and drinks is non-significant. Thus we can conclude that the interaction model is not the correct model for this study. 

Since each participant gave multiple responses (a "repeated measures" design), we can see that this would violate the independence assumption that’s important in linear modelling: multiple responses from the same subject cannot be regarded as independent from each other.
```{r}
ggplot(dat, aes(x = Drink, y = dat$Time,color=Participants)) +
  geom_boxplot() + 
  geom_point() +
  facet_wrap(~Participants, nrow = 2) +
  ggtitle(label="Tolerance by Participant") +
  theme_bw() +
  theme(legend.position = "none")
```
Participants has a strong influence on time but I  am not interested in individual spice tolerance so I'll set it as a nuisance variable. This means that I have no interest in its effects but will account for it through a linear mixed model. 
I will set drinks and temperature as our fixed variables of interest. I will set participants as a random factor meaning each participant will get their own intercept. This means analysis is done using participant's means when needed instead of grand mean. This solves variation bias of different participants

## Linear Mixed Model 
As mentioned before, Participants also have a strong influence on time however, we are not intereseted in the individual's spice tolerance so we will treat it as a nuisance variable. Meaning that we have no interest in its effects but will account for it through a linear mixed model. I will set drinks and temperature as our fixed variables of interest. Furthermore I will set participants as a random factor such that each participant will gets their own intercept. The model can be summarized as below:  
```{r}
sub_only = lmer(dat$Time ~ Drink + Temperature +  (1|Participants),  data = dat)
summary(sub_only)
```
With the anova table as:
```{r}
res <- residuals(sub_only)
anova(sub_only)
t(res) %*% res #this is sse since the anova of a mixed model masks the residuals. 
#From sta302 we learned the e'e results in SSE
```

## Checking Assumptions
In order for a linear model to be correct, an assumption that must be checked is the distribution of the error terms (residuals). We know that our error terms must be Normally distributed such that: $\epsilon_i \stackrel{iid}{\sim} N(\mu, \sigma^2)$. We can further check the normally distributed error term assumption by applying the qqnorm() function to our residuals in R:
```{r}
qqnorm(res)
```
We see that the qqnorm plot shows an approximately linear line, indicating the normal distribution requirement. Since each participant gave multiple responses (a "repeated measures" design), we can see that this would violate the independence assumption that’s important in linear modelling: multiple responses from the same subject cannot be regarded as independent from each other. However, this is countered by the use of the linear mixed model. Thus all assumptions of our are met. 

## Effect Size, Differences Relative to Variability, and Sample Size

```{r}
# Effect size = 1 - SSE/SST = 1 - (211378.7/ (142473 + 162076 + 211378.7))
eff_size = 0.59029
# 2 factors (4 levels & 2 levels)  -----> k =8
# Sample Size (n) = 6 participants
pwr.anova.test(k=8, n=NULL, f=eff_size, sig.level = 0.05, power=0.79201)

```
From the values obtained in the two way anova table under the section "Linear mixed models", the effect size that was calculated was 0.59029. 

The R squared value is much larger than 0.15 thus it suggests a large effect, therefore overall our model captures about 60% of variance and a standardized difference of 0.8 or more.  
From the code we see the following values:  
Power = 0.79201, f = 0.59029, significance level = 0.05 and k = 8

The combination of power of 0.79201, a significance level of 0.05 and a k of 8 produced an n of 6, which is the number of participants in each group.   

Differences relative to variability (d): d measures the differences in the groups using standard deviations as units, we can measure d for all pairs of levels under the factor. The pairs are Milk Refrigerated, Milk Room Temperature, Water Refrigerated, Water Room Temperature, Juice Refrigerated, Juice Room Temperature, Soda Refrigerated and Soda Room Temperature.




## Results  
Once accounting for participants as a nuisance factor, we achieve a p-value of  0.0001719 for drinks having the same mean and 3.507e-06 for refrigerated drinks and room temperature drinks having the same mean. Hence, we can reject both initial null hypotheses. We can conclude that colder drinks relieve spice much more effective and that not all drinks are equal for the purpose of relieving spice.

To take a closer look at the results of the experiment. We need to conduct pairwise tests of each treatment combination. Since the design of the experiment is balanced in the sense that there are 6 observations per group we can use Tukey's HSD to conduct the post hoc analysis as this test is most powerful when the groups are balanced.

```{r}
tukeys <- lsmeans(sub_only, pairwise~Drink*Temperature, adjust="tukey")
tukeys
```

Looking at specific results, we see the contrast of refrigerated milk and room temperature milk having the same mean is given a p-value of less than 0.0001 which is solely enough to determine that not all interactions of drinks and temperature have the same mean. Looking at refrigerated juice and milk vs their room temperature counterpart, they have a designated p-value of 000.1 which is enough to reject that room temperature and refrigerated drinks have the same mean. Finally, Refrigerated milk and refrigerated milk have a designated p-value of 0.003. Due to this, we reject the null hypothesis that all drinks have the same mean

## Summary

I've discussed and analyzed the variety of models to conclude that colder drinks relieve the feeling of spice more effectively and that not all drinks relieve spice equally. From the interaction plots I analyzed and found that the interaction plot was not the best model for this study from the fact that interactions were non-significant other than the interaction between participants and drinks. Then using the linear mixed model, I set drinks and temperature as our fixed variables of interest and participants as our random factor. Once I had the linear mixed model and checking all assumptions, O found effect size, mean of all standardized differences and sample size. Finally, after accounting for participants as a nuisance variable and finding p-values, we rejected all null hypotheses.











